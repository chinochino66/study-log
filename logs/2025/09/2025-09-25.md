# ä»Šæ—¥ã®åˆ°é”ç›®æ¨™

* `SELECT` ã¨ `WHERE` ã®åŸºæœ¬å¥ã‚’ **ãƒŸã‚¹ãªã**ä½¿ãˆã‚‹
* `NULL`ãƒ»`LIKE`ãƒ»`BETWEEN`ãƒ»`IN/NOT IN` ã‚’èª¬æ˜Žã§ãã‚‹
* Titanicã®å˜ä¸€è¡¨ã§ **ã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒª5æœ¬**ã‚’å‹•ã‹ã—ã€å„1ï½ž2è¡Œã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ã™
* LeetCode **5å•**ã‚’å›žç­”ï¼ˆSELECT/WHEREç³»ï¼‰

---

# 0. æº–å‚™

### DuckDBã‚’ä½¿ã†

* **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**ï¼šã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã‚‚ã„ã„ã‘ã©ã€ä»Šå›žã¯ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§

---

### æ‰‹é †ï¼ˆãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ï¼‰

â‘ DuckDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```python
# 1) ãƒŽãƒ¼ãƒˆã®ã‚«ãƒ¼ãƒãƒ«ã«å¯¾ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
%pip install -U duckdb

# 2) å¿µã®ãŸã‚ã€åŒã˜ã‚«ãƒ¼ãƒãƒ«ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
import sys
print("Python:", sys.executable)
import duckdb
print("duckdb:", duckdb.__version__)
```

â‘¡å‰å‡¦ç†ã«å¿…è¦ãªã‚»ãƒ«ã ã‘ä¸Šã‹ã‚‰å®Ÿè¡Œï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆâ†’CSVèª­è¾¼â†’æ¬ æè£œå®Œãƒ»å¤‰æ›â†’df_clean ä½œæˆï¼‰ã€‚

â‘¢ä¿å­˜ï¼‹çµ¶å¯¾ãƒ‘ã‚¹è¡¨ç¤ºï¼ˆã“ã‚Œã ã‘å®Ÿè¡Œï¼‰

```python
from pathlib import Path
df_clean.to_csv("cleaned_titanic.csv", index=False)
print("saved to:", Path("cleaned_titanic.csv").resolve())
```

â‘£ã™ãDuckDBã«å–ã‚Šè¾¼ã‚€

```python
import duckdb
con = duckdb.connect()
con.execute("""
    CREATE TABLE passengers AS
    SELECT * FROM read_csv_auto('ã“ã“ã«çµ¶å¯¾ãƒ‘ã‚¹ã‚’å…¥ã‚Œã‚‹', header=true);
""")
con.execute("SELECT COUNT(*) AS n FROM passengers;").df()
```

### ã‚«ãƒ¼ãƒãƒ«ã£ã¦ä½•ï¼Ÿ

Jupyter Notebookã‚’ä½¿ã†ã¨ãã€å®Ÿã¯ã€ŒãƒŽãƒ¼ãƒˆã®è£å´ã§Pythonã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã€ãŒã„ã‚‹ã€‚ãã‚Œã‚’ **ã‚«ãƒ¼ãƒãƒ«ï¼ˆKernelï¼‰** ã¨å‘¼ã¶ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹ã¨â”€â”€

* **ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯**ï¼šæ“ä½œç”»é¢ãƒ»ãƒŽãƒ¼ãƒˆã®ç´™ã¿ãŸã„ãªã‚‚ã®
* **ã‚«ãƒ¼ãƒãƒ«**ï¼šå®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆé ­è„³ï¼‰

ã‚»ãƒ«ã« `print("hello")` ã¨æ›¸ã„ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€ãã®ã‚³ãƒ¼ãƒ‰ã¯ã‚«ãƒ¼ãƒãƒ«ã«é€ã‚‰ã‚Œã€ã‚«ãƒ¼ãƒãƒ«ãŒå‡¦ç†ã—ã¦çµæžœã‚’è¿”ã—ã¦ã„ã‚‹ã€‚

---

### ã€Œã‚«ãƒ¼ãƒãƒ«å†èµ·å‹•ã€ãŒå¿…è¦ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°

* æ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚ŒãŸã¨ã â†’ æ—¢ã«å‹•ã„ã¦ã„ã‚‹ã‚«ãƒ¼ãƒãƒ«ã«ã¯ãã®æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„
* å®Ÿè¡Œã®æµã‚ŒãŒã‚°ãƒãƒ£ã‚°ãƒãƒ£ã«ãªã£ãŸã¨ã â†’ å¤‰æ•°ã‚„è¨­å®šãŒæ®‹ã£ã¦ã„ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

ã“ã®ã¨ãã€Œã‚«ãƒ¼ãƒãƒ«ã‚’å†èµ·å‹•ã€ã™ã‚‹ã¨ã€çœŸã£ã•ã‚‰ãªçŠ¶æ…‹ã®PythonãŒç«‹ã¡ä¸ŠãŒã‚‹ã‹ã‚‰ã€ç’°å¢ƒãŒæ•´ç†ã•ã‚Œã‚‹ã€‚

---

ðŸ’¡ ã ã‹ã‚‰ã€ä»Šæ—¥ã®ã‚±ãƒ¼ã‚¹ã§ã¯

1. `%pip install duckdb` ã§å…¥ã‚ŒãŸ
2. ã‚‚ã—ã™ãä½¿ãˆãªã‹ã£ãŸã‚‰ â†’ **ã‚«ãƒ¼ãƒãƒ«å†èµ·å‹•**
3. ã‚‚ã†ä¸€åº¦ `import duckdb` ã§OK

---

ã“ã“ã¾ã§ã§ã€ŒDuckDBã‚’ä½¿ã†æº–å‚™ã€ã¯å®Œäº†ã€‚

---

ã¾ãšåˆ—åã‚’ç¢ºèª
â€»Jupyterã§ã¯ã€DuckDBã®SQLã¯ con.execute("...") ã§å®Ÿè¡Œã™ã‚‹ã€‚

```python
# ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼ˆåˆ—åãƒ»åž‹ï¼‰ã‚’ç¢ºèª
con.execute("PRAGMA table_info('passengers');").df()
```

# 1. 20åˆ†ã§åŸºç¤Žã®â€œåž‹â€ã‚’å©ãè¾¼ã‚€

* è¡Œã®æŠ½å‡ºï¼š`WHERE æ¡ä»¶`ï¼ˆ**è¡Œ**ã‚’å‰Šã‚‹ï¼‰
* æ–‡å­—åˆ—ã‚ã„ã¾ã„ï¼š`LIKE '%Miss.%'`ï¼ˆ`_`ã¯1æ–‡å­—ã€`%`ã¯0æ–‡å­—ä»¥ä¸Šï¼‰
* ç¯„å›²ï¼š`BETWEEN a AND b`ï¼ˆä¸¡ç«¯å«ã‚€ï¼‰
* é›†åˆï¼š`IN (...)` / `NOT IN (...)`
* æ¬ æï¼š`IS NULL` / `IS NOT NULL`ï¼ˆâ€»`= NULL` ã¯**èª¤ã‚Š**ï¼‰
* ä»¶æ•°ï¼š`COUNT(*)` ã¯å…¨ä»¶ã€`COUNT(col)` ã¯ `NULL` ã‚’æ•°ãˆãªã„
* é †åºï¼†ä¸Šä½ï¼š`ORDER BY ...` + `LIMIT n`

---

# 2. å†™çµŒã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«5ï¼ˆTitanicï¼‰

**å„ã‚¯ã‚¨ãƒªã« â€œæ„å›³ã‚³ãƒ¡ãƒ³ãƒˆâ€ ã‚’1ã€œ2è¡Œã§æ›¸ãã€‚ã‚³ãƒ”ãƒšå¾Œã«å¿…ãšè‡ªåˆ†ã®è¨€è‘‰ã§è¦ç´„ã™ã‚‹ã€‚**

**Q1. æœ€é«˜é½¢ã®ç”Ÿå­˜è€…ãƒˆãƒƒãƒ—5**

```sql
con.execute("""
  SELECT Age, Pclass, Fare, Sex_female, HasCabin
  FROM passengers
  WHERE Survived = 1 AND Age IS NOT NULLã€€# Survived åˆ—ã¯ 0=æ­»äº¡ / 1=ç”Ÿå­˜ ã®2å€¤ã€‚
  ORDER BY Age DESC
  LIMIT 5;
""").df()
```
ã‚¯ã‚¨ãƒªã® WHERE Survived = 1 ã¯ã€ã€Œç”Ÿå­˜è€…ã ã‘ã«çµžã‚‹ï¼ˆ=æ­»äº¡è€…ã‚’é™¤å¤–ï¼‰ã€ã¨ã„ã†æ„å‘³.


**Q2. å¹´é½¢æ¬ æã®ä»¶æ•°ã¨æ¯”çŽ‡**

```sql
SELECT 
  SUM(CASE WHEN Age IS NULL THEN 1 ELSE 0 END) AS null_age,
  COUNT(*) AS total,
  1.0 * SUM(CASE WHEN Age IS NULL THEN 1 ELSE 0 END) / COUNT(*) AS ratio
FROM passengers;
```
çµæžœã€**ratio=0.0**ã«ãªã‚‹ã®ã¯æ­£ã—ã„ã€‚ç†ç”±ã¯ã•ã£ãå‰å‡¦ç†ã§`Age` ã‚’ **ä¸­å¤®å€¤ã§åŸ‹ã‚ãŸ**ã‹ã‚‰ã€ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã‚‚ã† `Age IS NULL` ãŒæ®‹ã£ã¦ã„ãªã„ã€‚

### ã„ã¾ã®SQLã‚’åˆ†è§£

* `SUM(CASE WHEN Age IS NULL THEN 1 ELSE 0 END)`
  â†’ æ¡ä»¶ã«åˆã†è¡Œã‚’1ã‚«ã‚¦ãƒ³ãƒˆã€åˆã‚ãªã„è¡Œã¯0ã€‚åˆè¨ˆã§ã€ŒNULLä»¶æ•°ã€ã«ãªã‚‹ã€‚
* `COUNT(*)` â†’ å…¨è¡Œæ•°ï¼ˆNULLã‚‚å«ã‚€ï¼‰ã€‚
* `1.0 * â€¦ / â€¦` â†’ ç‰‡æ–¹ã‚’**å°æ•°åž‹**ã«ã—ã¦ã€Œæ•´æ•°å‰²ã‚Šã®åˆ‡ã‚Šæ¨ã¦ã€ã‚’é˜²ãï¼ˆå¸¸ã«å®Ÿæ•°ã®æ¯”çŽ‡ã«ã™ã‚‹ï¼‰ã€‚

### æ¬¡ã®èª²é¡Œï¼ˆQ2â€²ï¼‰

ã€ŒCabinè¨˜éŒ²ãŒãªã„è¡Œã®ä»¶æ•°ã¨æ¯”çŽ‡ã€ã‚’æ±‚ã‚ã‚‹ã€‚

```python
con.execute("""
  SELECT 
    SUM(CASE WHEN HasCabin = 0 THEN 1 ELSE 0 END) AS no_cabin_cnt,
    COUNT(*) AS total,
    1.0 * SUM(CASE WHEN HasCabin = 0 THEN 1 ELSE 0 END) / COUNT(*) AS ratio
  FROM passengers;
""").df()
```

### HasCabinã£ã¦ä½•ï¼Ÿ

å‰å‡¦ç†ã§ä½œã£ãŸ**ãƒ•ãƒ©ã‚°åˆ—**ã€‚

```python
df["HasCabin"] = df["Cabin"].notna().astype(int)
```

* **1**ï¼šCabinã«â€œè¨˜éŒ²ãŒã‚ã‚‹â€ï¼ˆæ¬ æã˜ã‚ƒãªã„ï¼‰
* **0**ï¼šCabinãŒæ¬ æï¼ˆè¨˜éŒ²ãªã—ï¼‰

### `CASE WHEN HasCabin = 0 THEN 1 ELSE 0 END` ã®æ„å‘³

SQLç‰ˆã®ã€Œæ¡ä»¶å¼ã€ã€‚

* æ¡ä»¶ãŒ**çœŸ**ï¼ˆHasCabin=0ï¼‰ãªã‚‰ **1** ã‚’è¿”ã™
* ãã‚Œä»¥å¤–ã¯ **0** ã‚’è¿”ã™
  â†’ ã“ã‚Œã‚’ `SUM(...)` ã™ã‚Œã°ã€ã€ŒHasCabin=0 ã®è¡Œã®ä»¶æ•°ã€ã«ãªã‚‹ã€‚
  â†’ `AVG(...)` ã«ã™ã‚Œã°ã€ã€ŒHasCabin=0 ã®å‰²åˆã€ã«ãªã‚‹ã€‚ã€‡

## Q3â€²ï¼ˆç”Ÿå­˜çŽ‡ã‚’å‡ºã—ã¦ã¿ã‚‹ï¼‰

åŒã˜æ¡ä»¶ï¼ˆé‹è³ƒ20â€“50 & æ¸¯ãŒSã‹Cï¼‰ã§ã€ç”Ÿå­˜çŽ‡ã‚’å‡ºã™ã€‚

```python
con.execute("""
  SELECT AVG(CASE WHEN Survived=1 THEN 1 ELSE 0 END) AS survival_rate
  FROM passengers
  WHERE Fare BETWEEN 20 AND 50
    AND (Embarked_S=1 OR Embarked_C=1);
""").df()
```

**Q3. é‹è³ƒãƒ¬ãƒ³ã‚¸ Ã— ä¹—èˆ¹æ¸¯ãƒ•ã‚£ãƒ«ã‚¿**

```sql
con.execute("""
  SELECT Fare,
         CASE WHEN Embarked_S=1 THEN 'S'
              WHEN Embarked_C=1 THEN 'C'
              WHEN Embarked_Q=1 THEN 'Q'
              ELSE 'UNK' END AS Embarked_lbl,
         Survived
  FROM passengers
  WHERE Fare BETWEEN 20 AND 50
    AND (Embarked_S=1 OR Embarked_C=1)
  LIMIT 10;
""").df()
```

> ã­ã‚‰ã„ï¼š`BETWEEN` ã¨ `IN` ã®ä¸¦ç”¨ã€‚ç¯„å›²æŒ‡å®šã®æ„Ÿè¦šã‚’å¾—ã‚‹ã€‚

**Q4. ç§°å·æŠ½å‡ºï¼ˆLIKEï¼‰**

```sql
SELECT
  SUM(CASE WHEN Name LIKE '% Miss.%' THEN 1 ELSE 0 END) AS miss_cnt,
  SUM(CASE WHEN Name LIKE '% Mrs.%' THEN 1 ELSE 0 END)  AS mrs_cnt
FROM passengers;
```

> ã­ã‚‰ã„ï¼š`LIKE` ã®å‰å¾Œ `%`ã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚„ãƒ”ãƒªã‚ªãƒ‰ä½ç½®ã§ãƒ’ãƒƒãƒˆæ•°ãŒå¤‰ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã€‚

**Q5. å®¶æ—ã‚µã‚¤ã‚ºã‚’ä½œã£ã¦ç¢ºèª**

```sql
SELECT PassengerId, (SibSp + Parch + 1) AS family_size
FROM passengers
WHERE (SibSp + Parch + 1) >= 5
ORDER BY family_size DESC, PassengerId;
```

> ã­ã‚‰ã„ï¼š`SELECT` å†…ã§å¼ã‚’ä½œã‚‹ã€‚`WHERE` ã§ã‚‚åŒã˜å¼ã‚’å†åˆ©ç”¨ã€‚

> âœ… **KPIãƒã‚§ãƒƒã‚¯â‘ **ï¼šä¸Šã®5æœ¬ã‚’**ã™ã¹ã¦å®Ÿè¡Œ**ï¼‹å„1ã€œ2è¡Œã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã€‚

---

# 4. LeetCodeã€Œä»Šæ—¥ã‚„ã‚‹20å•ã€ï¼ˆSELECT/WHEREç³»ï¼‰


# 5. ä»•ä¸Šã’ï¼ˆ10åˆ†ï¼‰â€” â€œä»£è¡¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒŸãƒ‹é›†â€ ã‚’ãƒŽãƒ¼ãƒˆæœ«å°¾ã«

1. **æ¬ ææ¯”çŽ‡**

   ```sql
   SELECT AVG(CASE WHEN col IS NULL THEN 1 ELSE 0 END) AS null_ratio FROM t;
   ```
2. **éƒ¨åˆ†ä¸€è‡´ã‚«ã‚¦ãƒ³ãƒˆ**

   ```sql
   SELECT SUM(CASE WHEN name LIKE '%foo%' THEN 1 ELSE 0 END) FROM t;
   ```
3. **ç¯„å›²ï¼‹é›†åˆ**

   ```sql
   SELECT * FROM t WHERE x BETWEEN a AND b AND y IN ('A','B');
   ```
4. **ä¸Šä½N æŠœã**

   ```sql
   SELECT * FROM t ORDER BY score DESC LIMIT 10;
   ```
5. **å¼ã§ãƒ•ã‚£ãƒ«ã‚¿**

   ```sql
   SELECT id, (a+b) AS s FROM t WHERE (a+b) > 5;
   ```
