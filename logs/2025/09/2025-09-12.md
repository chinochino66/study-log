LINEでタスク未達成時の罰金システム構築完了。

# 運用で覚えておくこと（ランブック）

**日次の動き**

* 23時～0時 に GAS の `judgeAndChargeDailyPenalties()` が走り、
  `isAchievedToday_()`（GitHub当日コミット>0）で未達なら **オフセッション課金**。
* 3DS 要求時は GAS から返信される **認証URL**（`servePaymentHtml_`）を開けばOK。

**状態確認（LINEコマンド）**

* `ver` … デプロイ版の確認（Runtime=rev-…）
* `罰金状態` / `罰金` … 金額・今月使用・上限・カード表示
* `罰金額 300` / `罰金上限 5000` … 変更
* `今月リセット` / `罰金リセット` … 今月使用を0に
* `罰金停止` / `罰金再開` … 機能ON/OFF
* `罰金徴収 200` / `罰金テスト 200` … 手動徴収（動作確認に便利）

**鍵・環境まわり**

* **GAS** の Script Properties：

  * `STRIPE_SECRET_KEY`（sk\_…）/ `STRIPE_PUBLISHABLE_KEY`（pk\_…）←**本番は live 鍵**
  * `GITHUB_REPO` / `GITHUB_AUTHOR` / `GITHUB_TOKEN`
  * `BRIDGE_TOKEN`（GCF→GASブリッジ用）
  * `CHECKOUT_SUCCESS_URL` / `CHECKOUT_CANCEL_URL`（空なら `getExecUrl_()` を使用）
    
* **GCF（Cloud Functions Gen2）** の環境変数：

  * `STRIPE_WEBHOOK_SECRET`（**本番WebHookの whsec\_**）
  * `STRIPE_SECRET_KEY`（署名検証以外では未使用でもOK）
  * `GAS_WEBAPP_URL`（/exec のURL）/ `GAS_BRIDGE_TOKEN`（GAS側と一致）

**URLが変わる系**

* GAS を**新バージョンに切替**すると `/exec` URL が変わることがある →
  GCF の `GAS_WEBAPP_URL` を更新して **再デプロイ**。
* Stripe Webhook の URL は **GCF のサービスURL**。GCF を作り直したら Stripe 側も更新。

**テスト/本番の混線を避ける**

* テストで出来た `cus_…` / `pm_…` を本番では使えない。
  本番移行時は **USERSシートの stripe欄をクリア**してから再登録（今回実施済み）。

**モニタリング**

* Stripe ダッシュボード → Webhooks → 配信成功/失敗
* GCF ログ（受信/転送）
  `gcloud beta logging tail 'resource.type="cloud_run_revision" AND resource.labels.service_name="stripewebhook"'`
* GAS ログ/シート

  * `STRIPE_EVENTS` / `stripe_events` に行が増える
  * `ShowWebhookHeartbeat`（LAST\_WEBHOOK\_\* の確認）

---

# 再現レシピ（また同じ仕組みを作る時の手順）

1. **GitHub 学習ログ**

* リポジトリ作成（例 `user/study-log`）。PowerShell 自動コミットスクリプト運用。
* （任意）`GITHUB_TOKEN` を PAT で用意して GAS Script Properties に。

2. **GAS プロジェクト**

* 既存の GAS コード一式を貼付（`doPost`, `createCheckoutSetupSession_`, 罰金系関数など）。
* Script Properties を設定：

  * `STRIPE_SECRET_KEY=sk_live_…`
  * `STRIPE_PUBLISHABLE_KEY=pk_live_…`
  * `BRIDGE_TOKEN=ランダム文字列`
  * `GITHUB_REPO`, `GITHUB_AUTHOR`, （任意）`GITHUB_TOKEN`
  * `CHECKOUT_SUCCESS_URL` / `CHECKOUT_CANCEL_URL`
* ウェブアプリとして**デプロイ & 新バージョンに切替** → `/exec` URL を控える。
* 時間主導トリガーを作成：`judgeAndChargeDailyPenalties()` 

3. **GCF（Stripe Webhook 受け口＋GASブリッジ）**

* ローカルに `stripe-webhook` ディレクトリを作り、`index.js` を配置。
* プロジェクト/リージョンを設定：

  ```powershell
  gcloud config set core/project <PROJECT_ID>
  gcloud config set functions/region asia-northeast1
  ```
* 環境変数でデプロイ（**entry-point は index.js のエクスポート名**）：

  ```powershell
  $URL='https://script.google.com/macros/s/…/exec'
  $BRIDGE='…'   # GASのBRIDGE_TOKENと一致
  $SK='sk_live_…'
  $WHSEC='whsec_…'  

  gcloud functions deploy stripeWebhook --gen2 --region=asia-northeast1 `
    --runtime=nodejs20 --entry-point=stripeWebhook `
    --set-env-vars "STRIPE_SECRET_KEY=$SK,STRIPE_WEBHOOK_SECRET=$WHSEC,GAS_WEBAPP_URL=$URL,GAS_BRIDGE_TOKEN=$BRIDGE" `
    --allow-unauthenticated
  ```

4. **Stripe（ライブ）**

* **API鍵（ライブ）** を確認（sk\_live / pk\_live）。
* Webhook エンドポイント作成（**ライブモード**）：

  * URL：GCF のサービス URL（`gcloud functions describe … --format value(serviceConfig.uri)`）
  * イベント：`setup_intent.succeeded`, `payment_intent.succeeded`, `payment_intent.payment_failed`
  * 署名シークレット `whsec_…` を取得 → **GCF の環境変数に反映**して再デプロイ。

5. **LINE 側**

* 既存の LINE Webhook は GAS の `doPost` に向ける（現行どおり）。
* 「課金登録」を送って Checkout の URL が返ることを確認 → ライブカード登録。
* 「罰金状態」でカード/金額/上限が見えたら完成。

---

## 便利コマンド早見表

**GCF 環境変数確認**

```powershell
gcloud functions describe stripeWebhook --gen2 --region=asia-northeast1 `
  --format="json(serviceConfig.environmentVariables)"
```

**GCF ログ（最新）**

```powershell
gcloud beta logging tail `
 'resource.type="cloud_run_revision" AND resource.labels.service_name="stripewebhook"'
```

**Stripe（テスト）イベント確認**

```powershell
stripe events list --limit 5
```

---

## 安全運用メモ（将来の自分へ）

* 緊急停止は **LINE で「罰金停止」**。再開は「罰金再開」。
* 月初の自動リセットは `judgeAndChargeDailyPenalties` 内で `lastResetYm` 参照＋ `monthlyUsedJPY` 0化（実装済み）。
* 定期的に GAS のスプレッドシートをバックアップ（USERS, LOG, STRIPE\_EVENTS）。
* **鍵ローテ**：`pk/sk/whsec/BRIDGE_TOKEN` を更新したら、GAS と GCF の両方を揃えて**同日に切替**。
* デプロイ後は必ず **`ver`**、**「課金登録」**、**「罰金状態」** の**3点スモークテスト**。

---

何か壊れた気配がしたら、まずは `ver` でリビジョン確認 → GCF ログ → Stripe 配信履歴 → GAS の `LAST_WEBHOOK_*` を見る、の順で辿ればだいたい即座に原因にたどり着ける。

