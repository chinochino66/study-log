## 🧩 ① GROUP BY：グループごとにまとめる

**イメージ：**
「同じグループの人たちをまとめて平均や合計を出す」
👉「集計関数（SUM, COUNT, AVGなど）」とセットで使う。

### 例題：

```sql
SELECT department, AVG(salary) AS avg_salary
FROM employees
GROUP BY department;
```

**意味：**
社員テーブルから部署ごとの平均給与を出す。

| department | avg_salary |
| ---------- | ---------- |
| 営業         | 500000     |
| 開発         | 650000     |
| 人事         | 450000     |

💡POINT：

* SELECTに出せるのは「GROUP BYでまとめた列」か「集計関数」だけ。
* グループ化してない列はSELECTに出せない（→エラー）。

---

## 🧮 ② HAVING：グループに条件をつける

WHEREは「行」に条件をつける。
HAVINGは「グループ」に条件をつける。

### 例題：

```sql
SELECT department, AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 600000;
```

**意味：**
部署ごとの平均給与が60万を超える部署だけを出す。

💡POINT：

* HAVINGは「集計後の条件」。
* WHEREは「集計前の条件」。

---

## 🧠 ③ ウィンドウ関数（分析関数）

いよいよ中級の目玉！
「グループ化せずに」集計結果を各行に表示できる。

---

### 🔹 基本形

```sql
関数名() OVER (PARTITION BY 列名 ORDER BY 列名)
```

* **PARTITION BY**：グループ分け（GROUP BYに似てるけど、行は消えない）
* **ORDER BY**：順位づけなどの基準

---

### 例①：各部署内での給与順位

```sql
SELECT
  name,
  department,
  salary,
  RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS salary_rank
FROM employees;
```

| name | department | salary | salary_rank |
| ---- | ---------- | ------ | ----------- |
| 田中   | 営業         | 700000 | 1           |
| 鈴木   | 営業         | 600000 | 2           |
| 佐藤   | 開発         | 800000 | 1           |
| 中村   | 開発         | 650000 | 2           |

💡POINT：

* `RANK()`：同順位がある場合、次の順位は飛ぶ（1位, 2位, 2位, 4位）
* `DENSE_RANK()`：飛ばさない（1位, 2位, 2位, 3位）

---

### 例②：部署ごとの平均給与を各行に表示

```sql
SELECT
  name,
  department,
  salary,
  AVG(salary) OVER (PARTITION BY department) AS dept_avg
FROM employees;
```

| name | department | salary | dept_avg |
| ---- | ---------- | ------ | -------- |
| 田中   | 営業         | 700000 | 650000   |
| 鈴木   | 営業         | 600000 | 650000   |
| 佐藤   | 開発         | 800000 | 725000   |
| 中村   | 開発         | 650000 | 725000   |

💡GROUP BYだと「1行にまとめる」けど、
ウィンドウ関数は「行を残したまま分析できる」。

---

## 🎯 ④ 今日の15問の進め方

| 分野                | 問題例                  | 目標                  |
| ----------------- | -------------------- | ------------------- |
| GROUP BY          | 各部署の人数を数える           | COUNT()の使い方をマスター    |
| HAVING            | 平均給与が60万以上の部署を抽出     | WHEREとHAVINGの違いを理解  |
| GROUP BY＋ORDER BY | 集計結果を並び替える           | ソートの感覚を掴む           |
| ウィンドウ関数①          | RANK(), DENSE_RANK() | 順位づけ系の理解            |
| ウィンドウ関数②          | SUM() OVER()         | 累積合計（running total） |
| ウィンドウ関数③          | ROW_NUMBER()         | 1位だけ抽出などの応用         |

---

## 🧭 ⑤ 実践用データサンプル（試してOK）

```sql
CREATE TABLE employees (
  id INT,
  name TEXT,
  department TEXT,
  salary INT
);

INSERT INTO employees VALUES
(1, '田中', '営業', 700000),
(2, '鈴木', '営業', 600000),
(3, '佐藤', '開発', 800000),
(4, '中村', '開発', 650000),
(5, '伊藤', '人事', 450000),
(6, '高橋', '人事', 500000);
```
